# Google 第三方登入實作

所需工具程式

- Next.js
- Prisma
- NextAuth
- PlantScale

## 一、建立專案

一款超好用的 React 框架

輸入指令創建專案

```bash
npx create-next-app@latest
```

## 建立資料庫

前往 [PlantScale](https://app.planetscale.com) 登入並建立資料庫

<img width="100%" alt="Pasted Graphic" src="https://user-images.githubusercontent.com/98001197/283169989-9e6a9c9a-11c7-4a28-82c6-cc680286d7ae.png">

建立後選擇 Prisma

<img width="100%" alt="Pasted Graphic 2" src="https://user-images.githubusercontent.com/98001197/283170175-44d02ef3-2fc0-4dbc-8d67-462eb44fe0e4.png">

在專案裡的 `.env` 中貼上在網頁中獲取的 `DATABASE_UR='...'`

```env
DATABASE_URL='mysql://USERNAME:PASSWORD@aws.connect.psdb.cloud/test-database?sslaccept=strict'
```

## 設置 Prisma 與 NextAuth

安裝 Prisma

```bash
npm install prisma
```

初始化

```bash
npx prisma init
```

在 ./prisma/schema.prisma 中填入下列代碼

```prisma
// prisma/schema.prisma

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

接著將模型推上 PlantScale

```bash
npx prisma db push
```

## 建立全域的 Prisma

建立 lib/prisma.ts 填入下列程式碼

```ts
// lib/prisma.ts

import { PrismaClient } from '@prisma/client'

const prismaClientSingleton = () => {
  return new PrismaClient()
}

type PrismaClientSingleton = ReturnType<typeof prismaClientSingleton>

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClientSingleton | undefined
}

const prisma = globalForPrisma.prisma ?? prismaClientSingleton()

export default prisma

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

## 建立 NextAuth API

```bash
npm install @prisma/client @auth/prisma-adapter
```

<https://console.cloud.google.com/projectselector2/apis/dashboard?hl=zh-tw&supportedpurview=project>
建立專案
左方選單 `Auth 同意畫面` `外部` 開始建立同意畫面

左方選單 `憑證` `建立憑證` `OAuth 用戶端 ID`

<img width="100%" alt="image" src="https://user-images.githubusercontent.com/98001197/283320744-8e9ade3b-9512-460a-b1b2-21df6a3d8bdf.png">

將 `用戶端編號` `用戶端密鑰` 分別填入 .env

```env
GOOGLE_CLIENT_ID='用戶端編號'
GOOGLE_CLIENT_SECRET='用戶端密鑰'
```

建立 app/api/auth/[...nextauth]/route.ts

```ts
import prisma from "@/lib/prisma"
import { PrismaAdapter } from "@auth/prisma-adapter"
import NextAuth from "next-auth"
import GoogleProvider from "next-auth/providers/google"

const handler = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
  ],
})

export { handler as GET, handler as POST }
```

建立 components/providers/seesion.tsx

```tsx
"use client"

import { SessionProvider } from "next-auth/react"

export function MySessionProvider({ children }: { children: React.ReactNode }) {
  return <SessionProvider> {children} </SessionProvider>
}
```

更改 app/layout.tsx

```tsx
import { MySessionProvider } from '@/components/providers/session'
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'Auth Demo',
  description: 'Generated by create next app',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <MySessionProvider>
          {children}
        </MySessionProvider>
      </body>
    </html>
  )
}
```

更改 app/page.tsx

```tsx
'use client'

import { signIn, signOut, useSession } from "next-auth/react";

export default function Home() {
  const session = useSession();

  if (session.status === "loading") return (
    <main>
      載入中...
    </main>
  )

  if (session.status === "authenticated") return (
    <main>
      <button onClick={() => signOut()}>
        登出 {session.data?.user?.name}
      </button>
    </main>
  )

  if (session.status === "unauthenticated") return (
    <main>
      <button onClick={() => signIn('google')}>
        以 Google 登入
      </button>
    </main>
  )
}
```
